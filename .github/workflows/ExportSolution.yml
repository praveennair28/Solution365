name: export-and-branch-solution

# Export solution from DEV environment

#  unpack it and prepare, commit and push a git branch with the changes

 

on:

  workflow_dispatch:

    inputs:

      # Change this value

      solution_name:

        description: 'name of the solution to worked on from Power Platform'

        required: true

        default:  Test

       #Do Not change these values

      solution_exported_folder:

        description: 'folder name for staging the exported solution *do not change*'

        required: true

        default: out/exported/

      solution_folder:

        description: 'staging the unpacked solution folder before check-in *do not change*'

        required: true

        default: out/solutions/

      solution_target_folder:

       description: 'folder name to be created and checked in *do not change*'

       required: true

       default: solutions/

env:

#edit your values here

  ENVIRONMENT_URL: 'https://orgd6524967.crm8.dynamics.com/'

  CLIENT_ID: '277fac91-2641-4aee-952a-0e0dc026b695'

  TENANT_ID: 'fdd67221-13a8-4fc7-9764-c6f6ac35600f'
  
  NUGET_SOURCE_PATH: 'https://api.nuget.org/v3/index.json'
  
permissions: 
 id-token: write
 contents: write
 

jobs:

  export-unpack-commit:

    runs-on: ubuntu-latest
     
    steps:

    #checkout branch
     - name: create or checkout branch
       uses: actions/checkout@v4
       with:
        ref: dev
     - name: List files in the directory
       run:
         ls ${{ github.workspace }}

    #setup environment
     - name: setup .Net SDK
       uses: actions/setup-dotnet@3.0.2
       with:
        dotnet-version: '8.0.x'
        
     # - name: Add nuget source
     #  run: dotnet nuget add source ${{ env.NUGET_SOURCE_PATH }}

     
    #install power platform
     - name: install power platform tools
       uses: microsoft/powerplatform-actions/actions-install@v1.7.0
        
     - name: who am I?
       uses: microsoft/powerplatform-actions/who-am-i@v1.7.0
       with:
        app-id:  ${{ env.CLIENT_ID  }}
        client-secret: ${{secrets.PowerPlatformSPN}}       
        tenant-id:  ${{ env.TENANT_ID  }}
        environment-url:  ${{ env.ENVIRONMENT_URL  }}
              
          













       
    
